@model IEnumerable<moi.Models.HoaDon>
@{
    ViewBag.Title = "DonHang";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    var mode = ViewBag.Mode as string ?? "thang";
    var thongke = ViewBag.ThongKe;
}

<div class="container-fluid">
    <h2 class="text-danger fw-bold mb-4">📦 Quản lý Đơn hàng</h2>

    <!-- ========== PHẦN THỐNG KÊ DOANH THU ========== -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark fw-bold">
            <i class="bi bi-graph-up"></i> Thống kê doanh thu
        </div>
        <div class="card-body">
            <form method="get" action="/Admin/DonHang" class="d-flex align-items-center mb-3">
                <label class="me-2">Chế độ thống kê:</label>
                <select name="mode" class="form-select w-auto me-2" onchange="this.form.submit()">
                    <option value="ngay" @(mode == "ngay" ? "selected" : "")>Theo ngày</option>
                    <option value="thang" @(mode == "thang" ? "selected" : "")>Theo tháng</option>
                    <option value="nam" @(mode == "nam" ? "selected" : "")>Theo năm</option>
                </select>
            </form>

            <canvas id="chartDoanhThu" height="100"></canvas>
        </div>
    </div>

    <!-- ========== PHẦN DANH SÁCH ĐƠN HÀNG ========== -->
    <div class="card shadow-sm">
        <div class="card-header bg-danger text-white fw-bold">
            <i class="bi bi-receipt"></i> Danh sách đơn hàng
        </div>
        <div class="card-body table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-danger">
                    <tr>
                        <th>Mã đơn</th>
                        <th>Khách hàng</th>
                        <th>Ngày lập</th>
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.MaHD</td>
                            <td>@item.KhachHang.HoTen</td>
                            <td>@item.NgayLap</td>
                            <td>@String.Format("{0:N0} đ", item.TongTien)</td>
                            <td>
                                <span class="badge bg-@(item.TrangThai == "Hoàn tất" ? "success" :
                                                        item.TrangThai == "Đang giao" ? "info" :
                                                        item.TrangThai == "Đã hủy" ? "secondary" : "warning")">
                                    @item.TrangThai
                                </span>
                            </td>
                            <td>
                                <a href="/Admin/CapNhatDonHang/@item.MaHD" class="btn btn-sm btn-outline-primary">Chi tiết</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const data = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.ThongKe));

        const ctx = document.getElementById('chartDoanhThu').getContext('2d');
        const mode = '@mode';
        const labels = data.map(x =>
            mode === "ngay"
                ? new Date(x.Ngay).toLocaleDateString()
                : mode === "nam"
                    ? x.Nam.toString()
                    : x.Thang + "/" + x.Nam
        );
        const values = data.map(x => x.TongTien);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu (VNĐ)',
                    data: values,
                    backgroundColor: '#dc3545'
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { callback: v => v.toLocaleString() + " đ" }
                    }
                }
            }
        });
    </script>
}

