@{
    ViewBag.Title = "Quản lý Sản phẩm";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-danger fw-bold">
            <i class="fas fa-hamburger"></i> Quản lý Sản phẩm
        </h2>
        <button type="button" class="btn btn-success" onclick="openAddModal()">
            <i class="fas fa-plus"></i> Thêm sản phẩm
        </button>
    </div>

    <!-- Bảng danh sách sản phẩm -->
    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-hover" id="productTable">
                <thead class="table-danger">
                    <tr>
                        <th>Mã</th>
                        <th>Hình ảnh</th>
                        <th>Tên sản phẩm</th>
                        <th>Giá</th>
                        <th>Số lượng</th>
                        <th>Loại</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dữ liệu sẽ được load bằng AJAX -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Thêm/Sửa Sản phẩm -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalTitle">
                    <i class="fas fa-edit"></i> Thêm sản phẩm
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="productForm">
                    <input type="hidden" id="maSP" />

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="tenSP" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Giá <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="gia" required />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Số lượng</label>
                            <input type="number" class="form-control" id="soLuong" value="0" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Loại sản phẩm</label>
                            <select class="form-control" id="maLoai">
                                <option value="">-- Chọn loại --</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" id="moTa" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Hình ảnh</label>
                        <input type="file" class="form-control" id="anhFile" />
                        <input type="hidden" id="anh" />
                        <img id="previewImg" src="#" alt="Preview" class="mt-2" style="max-width:200px; display:none;" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct(event)">
                    <i class="fas fa-save"></i> Lưu
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        let productModal;
        let categories = [];

        $(document).ready(function () {
            productModal = new bootstrap.Modal(document.getElementById('productModal'));
            loadCategories();
            loadProducts();
        });

        function loadCategories() {
            $.get('/api/Product/Categories', function (data) {
                categories = data;
                $('#maLoai').empty().append('<option value="">-- Chọn loại --</option>');
                data.forEach(function (cat) {
                    $('#maLoai').append(`<option value="${cat.MaLoai}">${cat.TenLoai}</option>`);
                });
            });
        }

        function loadProducts() {
            $.get('/api/Product', function (data) {
                let html = '';
                data.forEach(function (sp) {
                    const imgHtml = sp.Anh && sp.Anh !== 'default.jpg'
                        ? `<img src="/Content/HinhAnhSP/${sp.Anh}" alt="${sp.TenSP}" style="width:60px; height:60px; object-fit:cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-image text-muted\\' style=\\'font-size:40px;\\'></i>';" />`
                        : `<i class="fas fa-image text-muted" style="font-size:40px;"></i>`;

                    html += `
                            <tr>
                                <td>${sp.MaSP}</td>
                                <td>${imgHtml}</td>
                                <td>${sp.TenSP}</td>
                                <td>${(sp.Gia || 0).toLocaleString()} đ</td>
                                <td>${sp.SoLuong || 0}</td>
                                <td><span class="badge bg-info">${sp.TenLoai || 'N/A'}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-warning" onclick="openEditModal(${sp.MaSP})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteProduct(${sp.MaSP}, '${sp.TenSP}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                });
                $('#productTable tbody').html(html);
            });
        }

        function openAddModal() {
            $('#modalTitle').html('<i class="fas fa-plus"></i> Thêm sản phẩm');
            $('#maSP').val('');
            $('#tenSP').val('');
            $('#gia').val('');
            $('#soLuong').val('0');
            $('#moTa').val('');
            $('#maLoai').val('');
            $('#anhFile').val('');
            $('#anh').val('');
            $('#previewImg').hide();
            productModal.show();
        }

        function openEditModal(maSP) {
            $('#modalTitle').html('<i class="fas fa-edit"></i> Sửa sản phẩm #' + maSP);

            $.get('/api/Product/' + maSP, function (sp) {
                $('#maSP').val(sp.MaSP);
                $('#tenSP').val(sp.TenSP);
                $('#gia').val(sp.Gia);
                $('#soLuong').val(sp.SoLuong);
                $('#moTa').val(sp.MoTa);
                $('#maLoai').val(sp.MaLoai);
                $('#anh').val(sp.Anh);
                $('#anhFile').val('');

                if (sp.Anh && sp.Anh !== 'default.jpg') {
                    $('#previewImg').attr('src', '/Content/HinhAnhSP/' + sp.Anh).show();
                } else {
                    $('#previewImg').hide();
                }

                productModal.show();
            });
        }

        function saveProduct(event) {
            if (event) { event.preventDefault(); event.stopPropagation(); }

            const maSP = $('#maSP').val();
            const isEdit = maSP !== '';
            const tenSP = $('#tenSP').val();
            const gia = $('#gia').val();
            const soLuong = $('#soLuong').val();
            const moTa = $('#moTa').val();
            const maLoai = $('#maLoai').val();
            const fileInput = document.getElementById('anhFile');

            if (!tenSP || tenSP.trim() === '') { alert('Nhập tên sản phẩm'); return; }
            if (!gia || parseFloat(gia) <= 0) { alert('Giá không hợp lệ'); return; }

            if (isEdit) {
                // Nếu có file mới -> multipart PUT
                if (fileInput.files.length > 0) {
                    updateProductWithImage(maSP);
                } else {
                    // Không đổi ảnh -> JSON PUT
                    saveProductData(maSP, true, $('#anh').val() || 'default.jpg');
                }
                return;
            }

            // Thêm mới: multipart
            const formData = new FormData();
            formData.append('TenSP', tenSP);
            formData.append('Gia', gia);
            formData.append('SoLuong', soLuong);
            formData.append('MoTa', moTa);
            formData.append('MaLoai', maLoai);
            if (fileInput.files.length > 0) {
                const f = fileInput.files[0];
                if (f.size > 5 * 1024 * 1024) { alert('File > 5MB'); return; }
                formData.append('AnhFile', f);
            }

            $.ajax({
                url: '/api/Product/create-with-image',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false
            }).done(res => {
                if (res.success) {
                    alert(res.message);
                    productModal.hide();
                    loadProducts();
                } else {
                    alert(res.message || 'Lỗi tạo sản phẩm');
                }
            }).fail(() => alert('Lỗi kết nối server!'));
        }

        function updateProductWithImage(id) {
            const fileInput = document.getElementById('anhFile');
            const f = fileInput.files[0];
            if (!f) { alert('Chọn ảnh mới'); return; }
            if (f.size > 5 * 1024 * 1024) { alert('File > 5MB'); return; }

            const formData = new FormData();
            formData.append('TenSP', $('#tenSP').val());
            formData.append('Gia', $('#gia').val());
            formData.append('SoLuong', $('#soLuong').val());
            formData.append('MoTa', $('#moTa').val());
            formData.append('MaLoai', $('#maLoai').val());
            formData.append('AnhFile', f);

            $.ajax({
                url: '/api/Product/update-with-image/' + id,
                type: 'PUT',
                data: formData,
                processData: false,
                contentType: false
            }).done(res => {
                if (res.success) {
                    alert(res.message);
                    productModal.hide();
                    loadProducts();
                } else {
                    alert(res.message || 'Lỗi cập nhật');
                }
            }).fail(() => alert('Lỗi kết nối server!'));
        }

        function saveProductData(maSP, isEdit, anhName) {
            const productData = {
                MaSP: maSP ? parseInt(maSP) : 0,
                TenSP: $('#tenSP').val(),
                Gia: parseFloat($('#gia').val()) || 0,
                SoLuong: parseInt($('#soLuong').val()) || 0,
                MoTa: $('#moTa').val(),
                MaLoai: $('#maLoai').val() ? parseInt($('#maLoai').val()) : null,
                Anh: anhName || 'default.jpg'
            };

            const url = isEdit ? `/api/Product/${maSP}` : '/api/Product';
            const method = isEdit ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(productData)
            }).done(response => {
                if (response.success) {
                    alert(response.message);
                    productModal.hide();
                    loadProducts();
                } else {
                    alert('Lỗi: ' + response.message);
                }
            }).fail(() => alert('Lỗi khi lưu sản phẩm!'));
        }

        function deleteProduct(maSP, tenSP) {
            if (!confirm(`Bạn có chắc muốn xóa sản phẩm "${tenSP}"?`)) return;

            $.ajax({
                url: '/api/Product/' + maSP,
                type: 'DELETE',
                success: function (response) {
                    if (response.success) {
                        alert(response.message);
                        loadProducts();
                    }
                },
                error: function () {
                    alert('Lỗi khi xóa sản phẩm!');
                }
            });
        }
    </script>
}